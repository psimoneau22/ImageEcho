@{
    ViewBag.Title = "Index";
}
<script src="~/Scripts/tradeSumoUtils.js"></script>

<div class="dropzone"></div>
<table id="resultsTable"></table>

<style>
    .result img {
        width: 100%;
        height: auto;
        max-width: 480px;
        padding: 0 20px;
    }

    .result span {
        display:block;
        text-align:center;
    }
</style>

<script>

    function displayResults(original, optimized, qualityFactor) {
        var resultTable = document.getElementById("resultsTable");
        var row = document.createElement("tr");
        row.appendChild(getImage(original, "Original"));
        row.appendChild(getImage(optimized, "Optimized", qualityFactor));

        resultsTable.insertBefore(row, resultsTable.firstChild);
    }

    function getImage(imageFile, caption, qualityFactor) {
        var result = document.createElement("td");
        result.className = "result";
        var img = document.createElement("img");
        img.src = window.URL.createObjectURL(imageFile);
        var captionSpan = document.createElement("span");
        captionSpan.textContent = caption + ": Size = " + imageFile.size;
        if (qualityFactor) {
            captionSpan.textContent += ": QualityFactor = " + qualityFactor;
        }
        result.appendChild(img);
        result.appendChild(captionSpan);
        return result;
    }    

    Dropzone.autoDiscover = false;
    $('.dropzone').dropzone({
        url: "/home/upload",
        autoProcessQueue: false,
        init: function () {
            var self = this;
            this.on("addedfile", function (file) {

                // change these settings to alter the quality;
                var settings = {                    
                    maxWidth: 800,
                    maxHeight: 600,
                    qualityFactor: .5
                }

                tradeSumoUtils.resizeImage(file, settings, function (optimizedFile) {
                    
                    // display the results:
                    displayResults(file, optimizedFile, settings.qualityFactor);

                    // attach this to our file so we can send it with our send function
                    file.optimizedFile = optimizedFile;
                    self.processQueue(); // send it to the server
                });
            });
            this.on("sending", function (file, xhr, formData) {
                formData.append("optimizedFile", file.optimizedFile);                
            });
            this.on("success", function (file, response) {
                console.log("successfully sent files to server, check the images folder");
            });
        }
    })
</script>
